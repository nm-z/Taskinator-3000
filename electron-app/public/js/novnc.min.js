/**
 * Minified by jsDelivr using Terser v5.15.1.
 * Original file: /npm/@novnc/novnc@1.4.0/core/rfb.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{toUnsigned32bit,toSigned32bit}from"./util/int.js";import*as Log from"./util/logging.js";import{encodeUTF8,decodeUTF8}from"./util/strings.js";import{dragThreshold}from"./util/browser.js";import{clientToElement}from"./util/element.js";import{setCapture}from"./util/events.js";import EventTargetMixin from"./util/eventtarget.js";import Display from"./display.js";import Inflator from"./inflator.js";import Deflator from"./deflator.js";import Keyboard from"./input/keyboard.js";import GestureHandler from"./input/gesturehandler.js";import Cursor from"./util/cursor.js";import Websock from"./websock.js";import DES from"./des.js";import KeyTable from"./input/keysym.js";import XtScancode from"./input/xtscancodes.js";import{encodings}from"./encodings.js";import RSAAESAuthenticationState from"./ra2.js";import{MD5}from"./util/md5.js";import RawDecoder from"./decoders/raw.js";import CopyRectDecoder from"./decoders/copyrect.js";import RREDecoder from"./decoders/rre.js";import HextileDecoder from"./decoders/hextile.js";import TightDecoder from"./decoders/tight.js";import TightPNGDecoder from"./decoders/tightpng.js";import ZRLEDecoder from"./decoders/zrle.js";import JPEGDecoder from"./decoders/jpeg.js";const DISCONNECT_TIMEOUT=3,DEFAULT_BACKGROUND="rgb(40, 40, 40)",MOUSE_MOVE_DELAY=17,WHEEL_STEP=50,WHEEL_LINE_HEIGHT=19,GESTURE_ZOOMSENS=75,GESTURE_SCRLSENS=50,DOUBLE_TAP_TIMEOUT=1e3,DOUBLE_TAP_THRESHOLD=50,securityTypeNone=1,securityTypeVNCAuth=2,securityTypeRA2ne=6,securityTypeTight=16,securityTypeVeNCrypt=19,securityTypeXVP=22,securityTypeARD=30,securityTypeMSLogonII=113,securityTypeUnixLogon=129,securityTypePlain=256,extendedClipboardFormatText=1,extendedClipboardFormatRtf=2,extendedClipboardFormatHtml=4,extendedClipboardFormatDib=8,extendedClipboardFormatFiles=16,extendedClipboardActionCaps=1<<24,extendedClipboardActionRequest=1<<25,extendedClipboardActionPeek=1<<26,extendedClipboardActionNotify=1<<27,extendedClipboardActionProvide=1<<28;export default class RFB extends EventTargetMixin{constructor(e,t,s){if(!e)throw new Error("Must specify target");if(!t)throw new Error("Must specify URL, WebSocket or RTCDataChannel");window.isSecureContext||Log.Error("noVNC requires a secure context (TLS). Expect crashes!"),super(),this._target=e,"string"==typeof t?this._url=t:(this._url=null,this._rawChannel=t),s=s||{},this._rfbCredentials=s.credentials||{},this._shared=!("shared"in s)||!!s.shared,this._repeaterID=s.repeaterID||"",this._wsProtocols=s.wsProtocols||[],this._rfbConnectionState="",this._rfbInitState="",this._rfbAuthScheme=-1,this._rfbCleanDisconnect=!0,this._rfbRSAAESAuthenticationState=null,this._rfbVersion=0,this._rfbMaxVersion=3.8,this._rfbTightVNC=!1,this._rfbVeNCryptState=0,this._rfbXvpVer=0,this._fbWidth=0,this._fbHeight=0,this._fbName="",this._capabilities={power:!1},this._supportsFence=!1,this._supportsContinuousUpdates=!1,this._enabledContinuousUpdates=!1,this._supportsSetDesktopSize=!1,this._screenID=0,this._screenFlags=0,this._qemuExtKeyEventSupported=!1,this._clipboardText=null,this._clipboardServerCapabilitiesActions={},this._clipboardServerCapabilitiesFormats={},this._sock=null,this._display=null,this._flushing=!1,this._keyboard=null,this._gestures=null,this._resizeObserver=null,this._disconnTimer=null,this._resizeTimeout=null,this._mouseMoveTimer=null,this._decoders={},this._FBU={rects:0,x:0,y:0,width:0,height:0,encoding:null},this._mousePos={},this._mouseButtonMask=0,this._mouseLastMoveTime=0,this._viewportDragging=!1,this._viewportDragPos={},this._viewportHasMoved=!1,this._accumulatedWheelDeltaX=0,this._accumulatedWheelDeltaY=0,this._gestureLastTapTime=null,this._gestureFirstDoubleTapEv=null,this._gestureLastMagnitudeX=0,this._gestureLastMagnitudeY=0,this._eventHandlers={focusCanvas:this._focusCanvas.bind(this),handleResize:this._handleResize.bind(this),handleMouse:this._handleMouse.bind(this),handleWheel:this._handleWheel.bind(this),handleGesture:this._handleGesture.bind(this),handleRSAAESCredentialsRequired:this._handleRSAAESCredentialsRequired.bind(this),handleRSAAESServerVerification:this._handleRSAAESServerVerification.bind(this)},Log.Debug(">> RFB.constructor"),this._screen=document.createElement("div"),this._screen.style.display="flex",this._screen.style.width="100%",this._screen.style.height="100%",this._screen.style.overflow="auto",this._screen.style.background="rgb(40, 40, 40)",this._canvas=document.createElement("canvas"),this._canvas.style.margin="auto",this._canvas.style.outline="none",this._canvas.width=0,this._canvas.height=0,this._canvas.tabIndex=-1,this._screen.appendChild(this._canvas),this._cursor=new Cursor,this._cursorImage=RFB.cursors.none,this._decoders[encodings.encodingRaw]=new RawDecoder,this._decoders[encodings.encodingCopyRect]=new CopyRectDecoder,this._decoders[encodings.encodingRRE]=new RREDecoder,this._decoders[encodings.encodingHextile]=new HextileDecoder,this._decoders[encodings.encodingTight]=new TightDecoder,this._decoders[encodings.encodingTightPNG]=new TightPNGDecoder,this._decoders[encodings.encodingZRLE]=new ZRLEDecoder,this._decoders[encodings.encodingJPEG]=new JPEGDecoder;try{this._display=new Display(this._canvas)}catch(e){throw Log.Error("Display exception: "+e),e}this._display.onflush=this._onFlush.bind(this),this._keyboard=new Keyboard(this._canvas),this._keyboard.onkeyevent=this._handleKeyEvent.bind(this),this._gestures=new GestureHandler,this._sock=new Websock,this._sock.on("open",this._socketOpen.bind(this)),this._sock.on("close",this._socketClose.bind(this)),this._sock.on("message",this._handleMessage.bind(this)),this._sock.on("error",this._socketError.bind(this)),this._expectedClientWidth=null,this._expectedClientHeight=null,this._resizeObserver=new ResizeObserver(this._eventHandlers.handleResize),this._updateConnectionState("connecting"),Log.Debug("<< RFB.constructor"),this.dragViewport=!1,this.focusOnClick=!0,this._viewOnly=!1,this._clipViewport=!1,this._clippingViewport=!1,this._scaleViewport=!1,this._resizeSession=!1,this._showDotCursor=!1,void 0!==s.showDotCursor&&(Log.Warn("Specifying showDotCursor as a RFB constructor argument is deprecated"),this._showDotCursor=s.showDotCursor),this._qualityLevel=6,this._compressionLevel=2}get viewOnly(){return this._viewOnly}set viewOnly(e){this._viewOnly=e,"connecting"!==this._rfbConnectionState&&"connected"!==this._rfbConnectionState||(e?this._keyboard.ungrab():this._keyboard.grab())}get capabilities(){return this._capabilities}get clippingViewport(){return this._clippingViewport}_setClippingViewport(e){e!==this._clippingViewport&&(this._clippingViewport=e,this.dispatchEvent(new CustomEvent("clippingviewport",{detail:this._clippingViewport})))}get touchButton(){return 0}set touchButton(e){Log.Warn("Using old API!")}get clipViewport(){return this._clipViewport}set clipViewport(e){this._clipViewport=e,this._updateClip()}get scaleViewport(){return this._scaleViewport}set scaleViewport(e){this._scaleViewport=e,e&&this._clipViewport&&this._updateClip(),this._updateScale(),!e&&this._clipViewport&&this._updateClip()}get resizeSession(){return this._resizeSession}set resizeSession(e){this._resizeSession=e,e&&this._requestRemoteResize()}get showDotCursor(){return this._showDotCursor}set showDotCursor(e){this._showDotCursor=e,this._refreshCursor()}get background(){return this._screen.style.background}set background(e){this._screen.style.background=e}get qualityLevel(){return this._qualityLevel}set qualityLevel(e){!Number.isInteger(e)||e<0||e>9?Log.Error("qualityLevel must be an integer between 0 and 9"):this._qualityLevel!==e&&(this._qualityLevel=e,"connected"===this._rfbConnectionState&&this._sendEncodings())}get compressionLevel(){return this._compressionLevel}set compressionLevel(e){!Number.isInteger(e)||e<0||e>9?Log.Error("compressionLevel must be an integer between 0 and 9"):this._compressionLevel!==e&&(this._compressionLevel=e,"connected"===this._rfbConnectionState&&this._sendEncodings())}disconnect(){this._updateConnectionState("disconnecting"),this._sock.off("error"),this._sock.off("message"),this._sock.off("open"),null!==this._rfbRSAAESAuthenticationState&&this._rfbRSAAESAuthenticationState.disconnect()}approveServer(){null!==this._rfbRSAAESAuthenticationState&&this._rfbRSAAESAuthenticationState.approveServer()}sendCredentials(e){this._rfbCredentials=e,this._resumeAuthentication()}sendCtrlAltDel(){"connected"!==this._rfbConnectionState||this._viewOnly||(Log.Info("Sending Ctrl-Alt-Del"),this.sendKey(KeyTable.XK_Control_L,"ControlLeft",!0),this.sendKey(KeyTable.XK_Alt_L,"AltLeft",!0),this.sendKey(KeyTable.XK_Delete,"Delete",!0),this.sendKey(KeyTable.XK_Delete,"Delete",!1),this.sendKey(KeyTable.XK_Alt_L,"AltLeft",!1),this.sendKey(KeyTable.XK_Control_L,"ControlLeft",!1))}machineShutdown(){this._xvpOp(1,2)}machineReboot(){this._xvpOp(1,3)}machineReset(){this._xvpOp(1,4)}sendKey(e,t,s){if("connected"!==this._rfbConnectionState||this._viewOnly)return;if(void 0===s)return this.sendKey(e,t,!0),void this.sendKey(e,t,!1);const i=XtScancode[t];if(this._qemuExtKeyEventSupported&&i)e=e||0,Log.Info("Sending key ("+(s?"down":"up")+"): keysym "+e+", scancode "+i),RFB.messages.QEMUExtendedKeyEvent(this._sock,e,s,i);else{if(!e)return;Log.Info("Sending keysym ("+(s?"down":"up")+"): "+e),RFB.messages.keyEvent(this._sock,e,s?1:0)}}focus(e){this._canvas.focus(e)}blur(){this._canvas.blur()}clipboardPasteFrom(e){if("connected"===this._rfbConnectionState&&!this._viewOnly)if(this._clipboardServerCapabilitiesFormats[1]&&this._clipboardServerCapabilitiesActions[134217728])this._clipboardText=e,RFB.messages.extendedClipboardNotify(this._sock,[1]);else{let t,s,i;t=0;for(let s of e)t++;i=new Uint8Array(t),s=0;for(let t of e){let e=t.codePointAt(0);e>255&&(e=63),i[s++]=e}RFB.messages.clientCutText(this._sock,i)}}getImageData(){return this._display.getImageData()}toDataURL(e,t){return this._display.toDataURL(e,t)}toBlob(e,t,s){return this._display.toBlob(e,t,s)}_connect(){if(Log.Debug(">> RFB.connect"),this._url)Log.Info(`connecting to ${this._url}`),this._sock.open(this._url,this._wsProtocols);else{if(Log.Info(`attaching ${this._rawChannel} to Websock`),this._sock.attach(this._rawChannel),"closed"===this._sock.readyState)throw Error("Cannot use already closed WebSocket/RTCDataChannel");"open"===this._sock.readyState&&this._socketOpen()}this._target.appendChild(this._screen),this._gestures.attach(this._canvas),this._cursor.attach(this._canvas),this._refreshCursor(),this._resizeObserver.observe(this._screen),this._canvas.addEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.addEventListener("touchstart",this._eventHandlers.focusCanvas),this._canvas.addEventListener("mousedown",this._eventHandlers.handleMouse),this._canvas.addEventListener("mouseup",this._eventHandlers.handleMouse),this._canvas.addEventListener("mousemove",this._eventHandlers.handleMouse),this._canvas.addEventListener("click",this._eventHandlers.handleMouse),this._canvas.addEventListener("contextmenu",this._eventHandlers.handleMouse),this._canvas.addEventListener("wheel",this._eventHandlers.handleWheel),this._canvas.addEventListener("gesturestart",this._eventHandlers.handleGesture),this._canvas.addEventListener("gesturemove",this._eventHandlers.handleGesture),this._canvas.addEventListener("gestureend",this._eventHandlers.handleGesture),Log.Debug("<< RFB.connect")}_disconnect(){Log.Debug(">> RFB.disconnect"),this._cursor.detach(),this._canvas.removeEventListener("gesturestart",this._eventHandlers.handleGesture),this._canvas.removeEventListener("gesturemove",this._eventHandlers.handleGesture),this._canvas.removeEventListener("gestureend",this._eventHandlers.handleGesture),this._canvas.removeEventListener("wheel",this._eventHandlers.handleWheel),this._canvas.removeEventListener("mousedown",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mouseup",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mousemove",this._eventHandlers.handleMouse),this._canvas.removeEventListener("click",this._eventHandlers.handleMouse),this._canvas.removeEventListener("contextmenu",this._eventHandlers.handleMouse),this._canvas.removeEventListener("mousedown",this._eventHandlers.focusCanvas),this._canvas.removeEventListener("touchstart",this._eventHandlers.focusCanvas),this._resizeObserver.disconnect(),this._keyboard.ungrab(),this._gestures.detach(),this._sock.close();try{this._target.removeChild(this._screen)}catch(e){if("NotFoundError"!==e.name)throw e}clearTimeout(this._resizeTimeout),clearTimeout(this._mouseMoveTimer),Log.Debug("<< RFB.disconnect")}_socketOpen(){"connecting"===this._rfbConnectionState&&""===this._rfbInitState?(this._rfbInitState="ProtocolVersion",Log.Debug("Starting VNC handshake")):this._fail("Unexpected server connection while "+this._rfbConnectionState)}_socketClose(e){Log.Debug("WebSocket on-close event");let t="";switch(e.code&&(t="(code: "+e.code,e.reason&&(t+=", reason: "+e.reason),t+=")"),this._rfbConnectionState){case"connecting":this._fail("Connection closed "+t);break;case"connected":this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected");break;case"disconnecting":this._updateConnectionState("disconnected");break;case"disconnected":this._fail("Unexpected server disconnect when already disconnected "+t);break;default:this._fail("Unexpected server disconnect before connecting "+t)}this._sock.off("close"),this._rawChannel=null}_socketError(e){Log.Warn("WebSocket on-error event")}_focusCanvas(e){this.focusOnClick&&this.focus({preventScroll:!0})}_setDesktopName(e){this._fbName=e,this.dispatchEvent(new CustomEvent("desktopname",{detail:{name:this._fbName}}))}_saveExpectedClientSize(){this._expectedClientWidth=this._screen.clientWidth,this._expectedClientHeight=this._screen.clientHeight}_currentClientSize(){return[this._screen.clientWidth,this._screen.clientHeight]}_clientHasExpectedSize(){const[e,t]=this._currentClientSize();return e==this._expectedClientWidth&&t==this._expectedClientHeight}_handleResize(){this._clientHasExpectedSize()||(window.requestAnimationFrame((()=>{this._updateClip(),this._updateScale()})),this._resizeSession&&(clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._requestRemoteResize.bind(this),500)))}_updateClip(){const e=this._display.clipViewport;let t=this._clipViewport;if(this._scaleViewport&&(t=!1),e!==t&&(this._display.clipViewport=t),t){const e=this._screenSize();this._display.viewportChangeSize(e.w,e.h),this._fixScrollbars(),this._setClippingViewport(e.w<this._display.width||e.h<this._display.height)}else this._setClippingViewport(!1);e!==t&&this._saveExpectedClientSize()}_updateScale(){if(this._scaleViewport){const e=this._screenSize();this._display.autoscale(e.w,e.h)}else this._display.scale=1;this._fixScrollbars()}_requestRemoteResize(){if(clearTimeout(this._resizeTimeout),this._resizeTimeout=null,!this._resizeSession||this._viewOnly||!this._supportsSetDesktopSize)return;const e=this._screenSize();RFB.messages.setDesktopSize(this._sock,Math.floor(e.w),Math.floor(e.h),this._screenID,this._screenFlags),Log.Debug("Requested new desktop size: "+e.w+"x"+e.h)}_screenSize(){let e=this._screen.getBoundingClientRect();return{w:e.width,h:e.height}}_fixScrollbars(){const e=this._screen.style.overflow;this._screen.style.overflow="hidden",this._screen.getBoundingClientRect(),this._screen.style.overflow=e}_updateConnectionState(e){const t=this._rfbConnectionState;if(e!==t)if("disconnected"!==t){switch(e){case"connected":if("connecting"!==t)return void Log.Error("Bad transition to connected state, previous connection state: "+t);break;case"disconnected":if("disconnecting"!==t)return void Log.Error("Bad transition to disconnected state, previous connection state: "+t);break;case"connecting":if(""!==t)return void Log.Error("Bad transition to connecting state, previous connection state: "+t);break;case"disconnecting":if("connected"!==t&&"connecting"!==t)return void Log.Error("Bad transition to disconnecting state, previous connection state: "+t);break;default:return void Log.Error("Unknown connection state: "+e)}switch(this._rfbConnectionState=e,Log.Debug("New state '"+e+"', was '"+t+"'."),this._disconnTimer&&"disconnecting"!==e&&(Log.Debug("Clearing disconnect timer"),clearTimeout(this._disconnTimer),this._disconnTimer=null,this._sock.off("close")),e){case"connecting":this._connect();break;case"connected":this.dispatchEvent(new CustomEvent("connect",{detail:{}}));break;case"disconnecting":this._disconnect(),this._disconnTimer=setTimeout((()=>{Log.Error("Disconnection timed out."),this._updateConnectionState("disconnected")}),3e3);break;case"disconnected":this.dispatchEvent(new CustomEvent("disconnect",{detail:{clean:this._rfbCleanDisconnect}}))}}else Log.Error("Tried changing state of a disconnected RFB object");else Log.Debug("Already in state '"+e+"', ignoring")}_fail(e){switch(this._rfbConnectionState){case"disconnecting":Log.Error("Failed when disconnecting: "+e);break;case"connected":Log.Error("Failed while connected: "+e);break;case"connecting":Log.Error("Failed when connecting: "+e);break;default:Log.Error("RFB failure: "+e)}return this._rfbCleanDisconnect=!1,this._updateConnectionState("disconnecting"),this._updateConnectionState("disconnected"),!1}_setCapability(e,t){this._capabilities[e]=t,this.dispatchEvent(new CustomEvent("capabilities",{detail:{capabilities:this._capabilities}}))}_handleMessage(){if(0!==this._sock.rQlen)switch(this._rfbConnectionState){case"disconnected":Log.Error("Got data while disconnected");break;case"connected":for(;!this._flushing&&this._normalMsg()&&0!==this._sock.rQlen;);break;case"connecting":for(;"connecting"===this._rfbConnectionState&&this._initMsg(););break;default:Log.Error("Got data while in an invalid state")}else Log.Warn("handleMessage called on an empty receive queue")}_handleKeyEvent(e,t,s){this.sendKey(e,t,s)}_handleMouse(e){if("click"===e.type&&e.target!==this._canvas)return;if(e.stopPropagation(),e.preventDefault(),"click"===e.type||"contextmenu"===e.type)return;let t=clientToElement(e.clientX,e.clientY,this._canvas);switch(e.type){case"mousedown":setCapture(this._canvas),this._handleMouseButton(t.x,t.y,!0,1<<e.button);break;case"mouseup":this._handleMouseButton(t.x,t.y,!1,1<<e.button);break;case"mousemove":this._handleMouseMove(t.x,t.y)}}_handleMouseButton(e,t,s,i){if(this.dragViewport){if(s&&!this._viewportDragging)return this._viewportDragging=!0,this._viewportDragPos={x:e,y:t},void(this._viewportHasMoved=!1);if(this._viewportDragging=!1,this._viewportHasMoved)return;this._sendMouse(e,t,i)}null!==this._mouseMoveTimer&&(clearTimeout(this._mouseMoveTimer),this._mouseMoveTimer=null,this._sendMouse(e,t,this._mouseButtonMask)),s?this._mouseButtonMask|=i:this._mouseButtonMask&=~i,this._sendMouse(e,t,this._mouseButtonMask)}_handleMouseMove(e,t){if(this._viewportDragging){const s=this._viewportDragPos.x-e,i=this._viewportDragPos.y-t;(this._viewportHasMoved||Math.abs(s)>dragThreshold||Math.abs(i)>dragThreshold)&&(this._viewportHasMoved=!0,this._viewportDragPos={x:e,y:t},this._display.viewportChangePos(s,i))}else if(this._mousePos={x:e,y:t},null==this._mouseMoveTimer){const s=Date.now()-this._mouseLastMoveTime;s>17?(this._sendMouse(e,t,this._mouseButtonMask),this._mouseLastMoveTime=Date.now()):this._mouseMoveTimer=setTimeout((()=>{this._handleDelayedMouseMove()}),17-s)}}_handleDelayedMouseMove(){this._mouseMoveTimer=null,this._sendMouse(this._mousePos.x,this._mousePos.y,this._mouseButtonMask),this._mouseLastMoveTime=Date.now()}_sendMouse(e,t,s){"connected"===this._rfbConnectionState&&(this._viewOnly||RFB.messages.pointerEvent(this._sock,this._display.absX(e),this._display.absY(t),s))}_handleWheel(e){if("connected"!==this._rfbConnectionState)return;if(this._viewOnly)return;e.stopPropagation(),e.preventDefault();let t=clientToElement(e.clientX,e.clientY,this._canvas),s=e.deltaX,i=e.deltaY;0!==e.deltaMode&&(s*=19,i*=19),this._accumulatedWheelDeltaX+=s,this._accumulatedWheelDeltaY+=i,Math.abs(this._accumulatedWheelDeltaX)>=50&&(this._accumulatedWheelDeltaX<0?(this._handleMouseButton(t.x,t.y,!0,32),this._handleMouseButton(t.x,t.y,!1,32)):this._accumulatedWheelDeltaX>0&&(this._handleMouseButton(t.x,t.y,!0,64),this._handleMouseButton(t.x,t.y,!1,64)),this._accumulatedWheelDeltaX=0),Math.abs(this._accumulatedWheelDeltaY)>=50&&(this._accumulatedWheelDeltaY<0?(this._handleMouseButton(t.x,t.y,!0,8),this._handleMouseButton(t.x,t.y,!1,8)):this._accumulatedWheelDeltaY>0&&(this._handleMouseButton(t.x,t.y,!0,16),this._handleMouseButton(t.x,t.y,!1,16)),this._accumulatedWheelDeltaY=0)}_fakeMouseMove(e,t,s){this._handleMouseMove(t,s),this._cursor.move(e.detail.clientX,e.detail.clientY)}_handleTapEvent(e,t){let s=clientToElement(e.detail.clientX,e.detail.clientY,this._canvas);if(null!==this._gestureLastTapTime&&Date.now()-this._gestureLastTapTime<1e3&&this._gestureFirstDoubleTapEv.detail.type===e.detail.type){let t=this._gestureFirstDoubleTapEv.detail.clientX-e.detail.clientX,i=this._gestureFirstDoubleTapEv.detail.clientY-e.detail.clientY;Math.hypot(t,i)<50?s=clientToElement(this._gestureFirstDoubleTapEv.detail.clientX,this._gestureFirstDoubleTapEv.detail.clientY,this._canvas):this._gestureFirstDoubleTapEv=e}else this._gestureFirstDoubleTapEv=e;this._gestureLastTapTime=Date.now(),this._fakeMouseMove(this._gestureFirstDoubleTapEv,s.x,s.y),this._handleMouseButton(s.x,s.y,!0,t),this._handleMouseButton(s.x,s.y,!1,t)}_handleGesture(e){let t,s=clientToElement(e.detail.clientX,e.detail.clientY,this._canvas);switch(e.type){case"gesturestart":switch(e.detail.type){case"onetap":this._handleTapEvent(e,1);break;case"twotap":this._handleTapEvent(e,4);break;case"threetap":this._handleTapEvent(e,2);break;case"drag":this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,!0,1);break;case"longpress":this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,!0,4);break;case"twodrag":this._gestureLastMagnitudeX=e.detail.magnitudeX,this._gestureLastMagnitudeY=e.detail.magnitudeY,this._fakeMouseMove(e,s.x,s.y);break;case"pinch":this._gestureLastMagnitudeX=Math.hypot(e.detail.magnitudeX,e.detail.magnitudeY),this._fakeMouseMove(e,s.x,s.y)}break;case"gesturemove":switch(e.detail.type){case"onetap":case"twotap":case"threetap":break;case"drag":case"longpress":this._fakeMouseMove(e,s.x,s.y);break;case"twodrag":for(this._fakeMouseMove(e,s.x,s.y);e.detail.magnitudeY-this._gestureLastMagnitudeY>50;)this._handleMouseButton(s.x,s.y,!0,8),this._handleMouseButton(s.x,s.y,!1,8),this._gestureLastMagnitudeY+=50;for(;e.detail.magnitudeY-this._gestureLastMagnitudeY<-50;)this._handleMouseButton(s.x,s.y,!0,16),this._handleMouseButton(s.x,s.y,!1,16),this._gestureLastMagnitudeY-=50;for(;e.detail.magnitudeX-this._gestureLastMagnitudeX>50;)this._handleMouseButton(s.x,s.y,!0,32),this._handleMouseButton(s.x,s.y,!1,32),this._gestureLastMagnitudeX+=50;for(;e.detail.magnitudeX-this._gestureLastMagnitudeX<-50;)this._handleMouseButton(s.x,s.y,!0,64),this._handleMouseButton(s.x,s.y,!1,64),this._gestureLastMagnitudeX-=50;break;case"pinch":if(this._fakeMouseMove(e,s.x,s.y),t=Math.hypot(e.detail.magnitudeX,e.detail.magnitudeY),Math.abs(t-this._gestureLastMagnitudeX)>75){for(this._handleKeyEvent(KeyTable.XK_Control_L,"ControlLeft",!0);t-this._gestureLastMagnitudeX>75;)this._handleMouseButton(s.x,s.y,!0,8),this._handleMouseButton(s.x,s.y,!1,8),this._gestureLastMagnitudeX+=75;for(;t-this._gestureLastMagnitudeX<-75;)this._handleMouseButton(s.x,s.y,!0,16),this._handleMouseButton(s.x,s.y,!1,16),this._gestureLastMagnitudeX-=75}this._handleKeyEvent(KeyTable.XK_Control_L,"ControlLeft",!1)}break;case"gestureend":switch(e.detail.type){case"onetap":case"twotap":case"threetap":case"pinch":case"twodrag":break;case"drag":this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,!1,1);break;case"longpress":this._fakeMouseMove(e,s.x,s.y),this._handleMouseButton(s.x,s.y,!1,4)}}}_negotiateProtocolVersion(){if(this._sock.rQwait("version",12))return!1;const e=this._sock.rQshiftStr(12).substr(4,7);Log.Info("Server ProtocolVersion: "+e);let t=0;switch(e){case"000.000":t=1;break;case"003.003":case"003.006":this._rfbVersion=3.3;break;case"003.007":this._rfbVersion=3.7;break;case"003.008":case"003.889":case"004.000":case"004.001":case"005.000":this._rfbVersion=3.8;break;default:return this._fail("Invalid server version "+e)}if(t){let e="ID:"+this._repeaterID;for(;e.length<250;)e+="\0";return this._sock.sendString(e),!0}this._rfbVersion>this._rfbMaxVersion&&(this._rfbVersion=this._rfbMaxVersion);const s="00"+parseInt(this._rfbVersion,10)+".00"+10*this._rfbVersion%10;this._sock.sendString("RFB "+s+"\n"),Log.Debug("Sent ProtocolVersion: "+s),this._rfbInitState="Security"}_isSupportedSecurityType(e){return[1,2,6,16,19,22,30,113,256].includes(e)}_negotiateSecurity(){if(this._rfbVersion>=3.7){const e=this._sock.rQshift8();if(this._sock.rQwait("security type",e,1))return!1;if(0===e)return this._rfbInitState="SecurityReason",this._securityContext="no security types",this._securityStatus=1,!0;const t=this._sock.rQshiftBytes(e);Log.Debug("Server security types: "+t),this._rfbAuthScheme=-1;for(let e of t)if(this._isSupportedSecurityType(e)){this._rfbAuthScheme=e;break}if(-1===this._rfbAuthScheme)return this._fail("Unsupported security types (types: "+t+")");this._sock.send([this._rfbAuthScheme])}else{if(this._sock.rQwait("security scheme",4))return!1;if(this._rfbAuthScheme=this._sock.rQshift32(),0==this._rfbAuthScheme)return this._rfbInitState="SecurityReason",this._securityContext="authentication scheme",this._securityStatus=1,!0}return this._rfbInitState="Authentication",Log.Debug("Authenticating using scheme: "+this._rfbAuthScheme),!0}_handleSecurityReason(){if(this._sock.rQwait("reason length",4))return!1;const e=this._sock.rQshift32();let t="";if(e>0){if(this._sock.rQwait("reason",e,4))return!1;t=this._sock.rQshiftStr(e)}return""!==t?(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._securityStatus,reason:t}})),this._fail("Security negotiation failed on "+this._securityContext+" (reason: "+t+")")):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:this._securityStatus}})),this._fail("Security negotiation failed on "+this._securityContext))}_negotiateXvpAuth(){if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password||void 0===this._rfbCredentials.target)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password","target"]}})),!1;const e=String.fromCharCode(this._rfbCredentials.username.length)+String.fromCharCode(this._rfbCredentials.target.length)+this._rfbCredentials.username+this._rfbCredentials.target;return this._sock.sendString(e),this._rfbAuthScheme=2,this._negotiateAuthentication()}_negotiateVeNCryptAuth(){if(0==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt version",2))return!1;const e=this._sock.rQshift8(),t=this._sock.rQshift8();if(0!=e||2!=t)return this._fail("Unsupported VeNCrypt version "+e+"."+t);this._sock.send([0,2]),this._rfbVeNCryptState=1}if(1==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt ack",1))return!1;const e=this._sock.rQshift8();if(0!=e)return this._fail("VeNCrypt failure "+e);this._rfbVeNCryptState=2}if(2==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt subtypes length",1))return!1;const e=this._sock.rQshift8();if(e<1)return this._fail("VeNCrypt subtypes empty");this._rfbVeNCryptSubtypesLength=e,this._rfbVeNCryptState=3}if(3==this._rfbVeNCryptState){if(this._sock.rQwait("vencrypt subtypes",4*this._rfbVeNCryptSubtypesLength))return!1;const e=[];for(let t=0;t<this._rfbVeNCryptSubtypesLength;t++)e.push(this._sock.rQshift32());this._rfbAuthScheme=-1;for(let t of e)if(19!==t&&this._isSupportedSecurityType(t)){this._rfbAuthScheme=t;break}return-1===this._rfbAuthScheme?this._fail("Unsupported security types (types: "+e+")"):(this._sock.send([this._rfbAuthScheme>>24,this._rfbAuthScheme>>16,this._rfbAuthScheme>>8,this._rfbAuthScheme]),this._rfbVeNCryptState,!0)}}_negotiatePlainAuth(){if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;const e=encodeUTF8(this._rfbCredentials.username),t=encodeUTF8(this._rfbCredentials.password);return this._sock.send([e.length>>24&255,e.length>>16&255,e.length>>8&255,255&e.length]),this._sock.send([t.length>>24&255,t.length>>16&255,t.length>>8&255,255&t.length]),this._sock.sendString(e),this._sock.sendString(t),this._rfbInitState="SecurityResult",!0}_negotiateStdVNCAuth(){if(this._sock.rQwait("auth challenge",16))return!1;if(void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["password"]}})),!1;const e=Array.prototype.slice.call(this._sock.rQshiftBytes(16)),t=RFB.genDES(this._rfbCredentials.password,e);return this._sock.send(t),this._rfbInitState="SecurityResult",!0}_negotiateARDAuth(){if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;if(null!=this._rfbCredentials.ardPublicKey&&null!=this._rfbCredentials.ardCredentials)return this._sock.send(this._rfbCredentials.ardCredentials),this._sock.send(this._rfbCredentials.ardPublicKey),this._rfbCredentials.ardCredentials=null,this._rfbCredentials.ardPublicKey=null,this._rfbInitState="SecurityResult",!0;if(this._sock.rQwait("read ard",4))return!1;let e=this._sock.rQshiftBytes(2),t=this._sock.rQshift16();if(this._sock.rQwait("read ard keylength",2*t,4))return!1;let s=this._sock.rQshiftBytes(t),i=this._sock.rQshiftBytes(t),n=window.crypto.getRandomValues(new Uint8Array(t)),r=Array.from(window.crypto.getRandomValues(new Uint8Array(64)),(e=>String.fromCharCode(65+e%26))).join("");return this._negotiateARDAuthAsync(e,t,s,i,n,r),!1}_modPow(e,t,s){let i="0x"+Array.from(e,(e=>("0"+(255&e).toString(16)).slice(-2))).join(""),n="0x"+Array.from(t,(e=>("0"+(255&e).toString(16)).slice(-2))).join(""),r="0x"+Array.from(s,(e=>("0"+(255&e).toString(16)).slice(-2))).join(""),o=BigInt(i),a=BigInt(n),h=BigInt(r),c=1n;for(o%=h;a>0;)a%2n===1n&&(c=c*o%h),a/=2n,o=o*o%h;let d=c.toString(16);for(;d.length/2<t.length||d.length%2!=0;)d="0"+d;let l=[];for(let e=0;e<d.length;e+=2)l.push(parseInt(d.substr(e,2),16));return l}async _aesEcbEncrypt(e,t){let s=Array.from(t,(e=>String.fromCharCode(e))).join(""),i=await window.crypto.subtle.importKey("raw",MD5(s),{name:"AES-CBC"},!1,["encrypt"]),n=new Uint8Array(e.length);for(let t=0;t<e.length;++t)n[t]=e.charCodeAt(t);let r=new Uint8Array(n.length);for(let e=0;e<n.length;e+=16){let t=n.slice(e,e+16),s=await window.crypto.subtle.encrypt({name:"AES-CBC",iv:t},i,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));r.set(new Uint8Array(s).slice(0,16),e)}return r}async _negotiateARDAuthAsync(e,t,s,i,n,r){let o=this._modPow(e,n,s),a=this._modPow(i,n,s),h=encodeUTF8(this._rfbCredentials.username).substring(0,63),c=encodeUTF8(this._rfbCredentials.password).substring(0,63),d=h+"\0"+r.substring(0,63),l=c+"\0"+r.substring(0,63),u=d.substring(0,64)+l.substring(0,64),_=await this._aesEcbEncrypt(u,a);this._rfbCredentials.ardCredentials=_,this._rfbCredentials.ardPublicKey=o,this._resumeAuthentication()}_negotiateTightUnixAuth(){return void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password?(this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1):(this._sock.send([0,0,0,this._rfbCredentials.username.length]),this._sock.send([0,0,0,this._rfbCredentials.password.length]),this._sock.sendString(this._rfbCredentials.username),this._sock.sendString(this._rfbCredentials.password),this._rfbInitState="SecurityResult",!0)}_negotiateTightTunnels(e){const t={vendor:"TGHT",signature:"NOTUNNEL"},s={};for(let t=0;t<e;t++){const e=this._sock.rQshift32(),t=this._sock.rQshiftStr(4),i=this._sock.rQshiftStr(8);s[e]={vendor:t,signature:i}}return Log.Debug("Server Tight tunnel types: "+s),s[1]&&"SICR"===s[1].vendor&&"SCHANNEL"===s[1].signature&&(Log.Debug("Detected Siemens server. Assuming NOTUNNEL support."),s[0]={vendor:"TGHT",signature:"NOTUNNEL"}),s[0]?s[0].vendor!=t.vendor||s[0].signature!=t.signature?this._fail("Client's tunnel type had the incorrect vendor or signature"):(Log.Debug("Selected tunnel type: "+t),this._sock.send([0,0,0,0]),!1):this._fail("Server wanted tunnels, but doesn't support the notunnel type")}_negotiateTightAuth(){if(!this._rfbTightVNC){if(this._sock.rQwait("num tunnels",4))return!1;const e=this._sock.rQshift32();if(e>0&&this._sock.rQwait("tunnel capabilities",16*e,4))return!1;if(this._rfbTightVNC=!0,e>0)return this._negotiateTightTunnels(e),!1}if(this._sock.rQwait("sub auth count",4))return!1;const e=this._sock.rQshift32();if(0===e)return this._rfbInitState="SecurityResult",!0;if(this._sock.rQwait("sub auth capabilities",16*e,4))return!1;const t={STDVNOAUTH__:1,STDVVNCAUTH_:2,TGHTULGNAUTH:129},s=[];for(let t=0;t<e;t++){this._sock.rQshift32();const e=this._sock.rQshiftStr(12);s.push(e)}Log.Debug("Server Tight authentication types: "+s);for(let e in t)if(-1!=s.indexOf(e))switch(this._sock.send([0,0,0,t[e]]),Log.Debug("Selected authentication type: "+e),e){case"STDVNOAUTH__":return this._rfbInitState="SecurityResult",!0;case"STDVVNCAUTH_":return this._rfbAuthScheme=2,!0;case"TGHTULGNAUTH":return this._rfbAuthScheme=129,!0;default:return this._fail("Unsupported tiny auth scheme (scheme: "+e+")")}return this._fail("No supported sub-auth types!")}_handleRSAAESCredentialsRequired(e){this.dispatchEvent(e)}_handleRSAAESServerVerification(e){this.dispatchEvent(e)}_negotiateRA2neAuth(){return null===this._rfbRSAAESAuthenticationState&&(this._rfbRSAAESAuthenticationState=new RSAAESAuthenticationState(this._sock,(()=>this._rfbCredentials)),this._rfbRSAAESAuthenticationState.addEventListener("serververification",this._eventHandlers.handleRSAAESServerVerification),this._rfbRSAAESAuthenticationState.addEventListener("credentialsrequired",this._eventHandlers.handleRSAAESCredentialsRequired)),this._rfbRSAAESAuthenticationState.checkInternalEvents(),this._rfbRSAAESAuthenticationState.hasStarted||this._rfbRSAAESAuthenticationState.negotiateRA2neAuthAsync().catch((e=>{"disconnect normally"!==e.message&&this._fail(e.message)})).then((()=>(this.dispatchEvent(new CustomEvent("securityresult")),this._rfbInitState="SecurityResult",!0))).finally((()=>{this._rfbRSAAESAuthenticationState.removeEventListener("serververification",this._eventHandlers.handleRSAAESServerVerification),this._rfbRSAAESAuthenticationState.removeEventListener("credentialsrequired",this._eventHandlers.handleRSAAESCredentialsRequired),this._rfbRSAAESAuthenticationState=null})),!1}_negotiateMSLogonIIAuth(){if(this._sock.rQwait("mslogonii dh param",24))return!1;if(void 0===this._rfbCredentials.username||void 0===this._rfbCredentials.password)return this.dispatchEvent(new CustomEvent("credentialsrequired",{detail:{types:["username","password"]}})),!1;const e=this._sock.rQshiftBytes(8),t=this._sock.rQshiftBytes(8),s=this._sock.rQshiftBytes(8),i=window.crypto.getRandomValues(new Uint8Array(8)),n=new Uint8Array(this._modPow(e,i,t)),r=new Uint8Array(this._modPow(s,i,t)),o=new DES(r),a=encodeUTF8(this._rfbCredentials.username).substring(0,255),h=encodeUTF8(this._rfbCredentials.password).substring(0,63),c=new Uint8Array(256),d=new Uint8Array(64);window.crypto.getRandomValues(c),window.crypto.getRandomValues(d);for(let e=0;e<a.length;e++)c[e]=a.charCodeAt(e);c[a.length]=0;for(let e=0;e<h.length;e++)d[e]=h.charCodeAt(e);d[h.length]=0;let l=new Uint8Array(r);for(let e=0;e<32;e++){for(let t=0;t<8;t++)l[t]^=c[8*e+t];l=o.enc8(l),c.set(l,8*e)}l=new Uint8Array(r);for(let e=0;e<8;e++){for(let t=0;t<8;t++)l[t]^=d[8*e+t];l=o.enc8(l),d.set(l,8*e)}return this._sock.send(n),this._sock.send(c),this._sock.send(d),this._rfbInitState="SecurityResult",!0}_negotiateAuthentication(){switch(this._rfbAuthScheme){case 1:return this._rfbInitState="SecurityResult",!0;case 22:return this._negotiateXvpAuth();case 30:return this._negotiateARDAuth();case 2:return this._negotiateStdVNCAuth();case 16:return this._negotiateTightAuth();case 19:return this._negotiateVeNCryptAuth();case 256:return this._negotiatePlainAuth();case 129:return this._negotiateTightUnixAuth();case 6:return this._negotiateRA2neAuth();case 113:return this._negotiateMSLogonIIAuth();default:return this._fail("Unsupported auth scheme (scheme: "+this._rfbAuthScheme+")")}}_handleSecurityResult(){if(this._rfbVersion<3.7)return this._rfbInitState="ClientInitialisation",!0;if(this._sock.rQwait("VNC auth response ",4))return!1;const e=this._sock.rQshift32();return 0===e?(this._rfbInitState="ClientInitialisation",Log.Debug("Authentication OK"),!0):this._rfbVersion>=3.8?(this._rfbInitState="SecurityReason",this._securityContext="security result",this._securityStatus=e,!0):(this.dispatchEvent(new CustomEvent("securityfailure",{detail:{status:e}})),this._fail("Security handshake failed"))}_negotiateServerInit(){if(this._sock.rQwait("server initialization",24))return!1;const e=this._sock.rQshift16(),t=this._sock.rQshift16(),s=this._sock.rQshift8(),i=this._sock.rQshift8(),n=this._sock.rQshift8(),r=this._sock.rQshift8(),o=this._sock.rQshift16(),a=this._sock.rQshift16(),h=this._sock.rQshift16(),c=this._sock.rQshift8(),d=this._sock.rQshift8(),l=this._sock.rQshift8();this._sock.rQskipBytes(3);const u=this._sock.rQshift32();if(this._sock.rQwait("server init name",u,24))return!1;let _=this._sock.rQshiftStr(u);if(_=decodeUTF8(_,!0),this._rfbTightVNC){if(this._sock.rQwait("TightVNC extended server init header",8,24+u))return!1;const e=this._sock.rQshift16(),t=this._sock.rQshift16(),s=this._sock.rQshift16();this._sock.rQskipBytes(2);const i=16*(e+t+s);if(this._sock.rQwait("TightVNC extended server init header",i,32+u))return!1;this._sock.rQskipBytes(16*e),this._sock.rQskipBytes(16*t),this._sock.rQskipBytes(16*s)}return Log.Info("Screen: "+e+"x"+t+", bpp: "+s+", depth: "+i+", bigEndian: "+n+", trueColor: "+r+", redMax: "+o+", greenMax: "+a+", blueMax: "+h+", redShift: "+c+", greenShift: "+d+", blueShift: "+l),this._setDesktopName(_),this._resize(e,t),this._viewOnly||this._keyboard.grab(),this._fbDepth=24,"Intel(r) AMT KVM"===this._fbName&&(Log.Warn("Intel AMT KVM only supports 8/16 bit depths. Using low color mode."),this._fbDepth=8),RFB.messages.pixelFormat(this._sock,this._fbDepth,!0),this._sendEncodings(),RFB.messages.fbUpdateRequest(this._sock,!1,0,0,this._fbWidth,this._fbHeight),this._updateConnectionState("connected"),!0}_sendEncodings(){const e=[];e.push(encodings.encodingCopyRect),24==this._fbDepth&&(e.push(encodings.encodingTight),e.push(encodings.encodingTightPNG),e.push(encodings.encodingZRLE),e.push(encodings.encodingJPEG),e.push(encodings.encodingHextile),e.push(encodings.encodingRRE)),e.push(encodings.encodingRaw),e.push(encodings.pseudoEncodingQualityLevel0+this._qualityLevel),e.push(encodings.pseudoEncodingCompressLevel0+this._compressionLevel),e.push(encodings.pseudoEncodingDesktopSize),e.push(encodings.pseudoEncodingLastRect),e.push(encodings.pseudoEncodingQEMUExtendedKeyEvent),e.push(encodings.pseudoEncodingExtendedDesktopSize),e.push(encodings.pseudoEncodingXvp),e.push(encodings.pseudoEncodingFence),e.push(encodings.pseudoEncodingContinuousUpdates),e.push(encodings.pseudoEncodingDesktopName),e.push(encodings.pseudoEncodingExtendedClipboard),24==this._fbDepth&&(e.push(encodings.pseudoEncodingVMwareCursor),e.push(encodings.pseudoEncodingCursor)),RFB.messages.clientEncodings(this._sock,e)}_initMsg(){switch(this._rfbInitState){case"ProtocolVersion":return this._negotiateProtocolVersion();case"Security":return this._negotiateSecurity();case"Authentication":return this._negotiateAuthentication();case"SecurityResult":return this._handleSecurityResult();case"SecurityReason":return this._handleSecurityReason();case"ClientInitialisation":return this._sock.send([this._shared?1:0]),this._rfbInitState="ServerInitialisation",!0;case"ServerInitialisation":return this._negotiateServerInit();default:return this._fail("Unknown init state (state: "+this._rfbInitState+")")}}_resumeAuthentication(){setTimeout(this._initMsg.bind(this),0)}_handleSetColourMapMsg(){return Log.Debug("SetColorMapEntries"),this._fail("Unexpected SetColorMapEntries message")}_handleServerCutText(){if(Log.Debug("ServerCutText"),this._sock.rQwait("ServerCutText header",7,1))return!1;this._sock.rQskipBytes(3);let e=this._sock.rQshift32();if(e=toSigned32bit(e),this._sock.rQwait("ServerCutText content",Math.abs(e),8))return!1;if(e>=0){const t=this._sock.rQshiftStr(e);if(this._viewOnly)return!0;this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:t}}))}else{e=Math.abs(e);const t=this._sock.rQshift32();let s=65535&t,i=4278190080&t;if(!!(16777216&i)){this._clipboardServerCapabilitiesFormats={},this._clipboardServerCapabilitiesActions={};for(let e=0;e<=15;e++){let t=1<<e;s&t&&(this._clipboardServerCapabilitiesFormats[t]=!0,this._sock.rQshift32())}for(let e=24;e<=31;e++){let t=1<<e;this._clipboardServerCapabilitiesActions[t]=!!(i&t)}let e=[16777216,33554432,67108864,134217728,268435456];RFB.messages.extendedClipboardCaps(this._sock,e,{extendedClipboardFormatText:0})}else if(33554432===i){if(this._viewOnly)return!0;null!=this._clipboardText&&this._clipboardServerCapabilitiesActions[268435456]&&1&s&&RFB.messages.extendedClipboardProvide(this._sock,[1],[this._clipboardText])}else if(67108864===i){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[134217728]&&(null!=this._clipboardText?RFB.messages.extendedClipboardNotify(this._sock,[1]):RFB.messages.extendedClipboardNotify(this._sock,[]))}else if(134217728===i){if(this._viewOnly)return!0;this._clipboardServerCapabilitiesActions[33554432]&&1&s&&RFB.messages.extendedClipboardRequest(this._sock,[1])}else{if(268435456!==i)return this._fail("Unexpected action in extended clipboard message: "+i);{if(this._viewOnly)return!0;if(!(1&s))return!0;this._clipboardText=null;let t=this._sock.rQshiftBytes(e-4),i=new Inflator,n=null;i.setInput(t);for(let e=0;e<=15;e++){let t=1<<e;if(s&t){let e=0,s=i.inflate(4);e|=s[0]<<24,e|=s[1]<<16,e|=s[2]<<8,e|=s[3];let r=i.inflate(e);1===t&&(n=r)}}if(i.setInput(null),null!==n){let e="";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);n=e,n=decodeUTF8(n),n.length>0&&"\0"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),n=n.replace("\r\n","\n"),this.dispatchEvent(new CustomEvent("clipboard",{detail:{text:n}}))}}}}return!0}_handleServerFenceMsg(){if(this._sock.rQwait("ServerFence header",8,1))return!1;this._sock.rQskipBytes(3);let e=this._sock.rQshift32(),t=this._sock.rQshift8();if(this._sock.rQwait("ServerFence payload",t,9))return!1;t>64&&(Log.Warn("Bad payload length ("+t+") in fence response"),t=64);const s=this._sock.rQshiftStr(t);return this._supportsFence=!0,e&1<<31?(e&=3,RFB.messages.clientFence(this._sock,e,s),!0):this._fail("Unexpected fence response")}_handleXvpMsg(){if(this._sock.rQwait("XVP version and message",3,1))return!1;this._sock.rQskipBytes(1);const e=this._sock.rQshift8(),t=this._sock.rQshift8();switch(t){case 0:Log.Error("XVP Operation Failed");break;case 1:this._rfbXvpVer=e,Log.Info("XVP extensions enabled (version "+this._rfbXvpVer+")"),this._setCapability("power",!0);break;default:this._fail("Illegal server XVP message (msg: "+t+")")}return!0}_normalMsg(){let e,t,s;switch(e=this._FBU.rects>0?0:this._sock.rQshift8(),e){case 0:return s=this._framebufferUpdate(),s&&!this._enabledContinuousUpdates&&RFB.messages.fbUpdateRequest(this._sock,!0,0,0,this._fbWidth,this._fbHeight),s;case 1:return this._handleSetColourMapMsg();case 2:return Log.Debug("Bell"),this.dispatchEvent(new CustomEvent("bell",{detail:{}})),!0;case 3:return this._handleServerCutText();case 150:return t=!this._supportsContinuousUpdates,this._supportsContinuousUpdates=!0,this._enabledContinuousUpdates=!1,t&&(this._enabledContinuousUpdates=!0,this._updateContinuousUpdates(),Log.Info("Enabling continuous updates.")),!0;case 248:return this._handleServerFenceMsg();case 250:return this._handleXvpMsg();default:return this._fail("Unexpected server message (type "+e+")"),Log.Debug("sock.rQslice(0, 30): "+this._sock.rQslice(0,30)),!0}}_onFlush(){this._flushing=!1,this._sock.rQlen>0&&this._handleMessage()}_framebufferUpdate(){if(0===this._FBU.rects){if(this._sock.rQwait("FBU header",3,1))return!1;if(this._sock.rQskipBytes(1),this._FBU.rects=this._sock.rQshift16(),this._display.pending())return this._flushing=!0,this._display.flush(),!1}for(;this._FBU.rects>0;){if(null===this._FBU.encoding){if(this._sock.rQwait("rect header",12))return!1;const e=this._sock.rQshiftBytes(12);this._FBU.x=(e[0]<<8)+e[1],this._FBU.y=(e[2]<<8)+e[3],this._FBU.width=(e[4]<<8)+e[5],this._FBU.height=(e[6]<<8)+e[7],this._FBU.encoding=parseInt((e[8]<<24)+(e[9]<<16)+(e[10]<<8)+e[11],10)}if(!this._handleRect())return!1;this._FBU.rects--,this._FBU.encoding=null}return this._display.flip(),!0}_handleRect(){switch(this._FBU.encoding){case encodings.pseudoEncodingLastRect:return this._FBU.rects=1,!0;case encodings.pseudoEncodingVMwareCursor:return this._handleVMwareCursor();case encodings.pseudoEncodingCursor:return this._handleCursor();case encodings.pseudoEncodingQEMUExtendedKeyEvent:return this._qemuExtKeyEventSupported=!0,!0;case encodings.pseudoEncodingDesktopName:return this._handleDesktopName();case encodings.pseudoEncodingDesktopSize:return this._resize(this._FBU.width,this._FBU.height),!0;case encodings.pseudoEncodingExtendedDesktopSize:return this._handleExtendedDesktopSize();default:return this._handleDataRect()}}_handleVMwareCursor(){const e=this._FBU.x,t=this._FBU.y,s=this._FBU.width,i=this._FBU.height;if(this._sock.rQwait("VMware cursor encoding",1))return!1;const n=this._sock.rQshift8();let r;this._sock.rQshift8();if(0==n){const e=-256;if(r=new Array(s*i*4),this._sock.rQwait("VMware cursor classic encoding",s*i*4*2,2))return!1;let t=new Array(s*i);for(let e=0;e<s*i;e++)t[e]=this._sock.rQshift32();let n=new Array(s*i);for(let e=0;e<s*i;e++)n[e]=this._sock.rQshift32();for(let o=0;o<s*i;o++)if(0==t[o]){let e=n[o],t=e>>8&255,s=e>>16&255,i=e>>24&255;r[4*o]=t,r[4*o+1]=s,r[4*o+2]=i,r[4*o+3]=255}else(t[o]&e)==e?0==n[o]?(r[4*o]=0,r[4*o+1]=0,r[4*o+2]=0,r[4*o+3]=0):(n[o],r[4*o]=0,r[4*o+1]=0,r[4*o+2]=0,r[4*o+3]=255):(r[4*o]=0,r[4*o+1]=0,r[4*o+2]=0,r[4*o+3]=255)}else{if(1!=n)return Log.Warn("The given cursor type is not supported: "+n+" given."),!1;if(this._sock.rQwait("VMware cursor alpha encoding",s*i*4,2))return!1;r=new Array(s*i*4);for(let e=0;e<s*i;e++){let t=this._sock.rQshift32();r[4*e]=t>>24&255,r[4*e+1]=t>>16&255,r[4*e+2]=t>>8&255,r[4*e+3]=255&t}}return this._updateCursor(r,e,t,s,i),!0}_handleCursor(){const e=this._FBU.x,t=this._FBU.y,s=this._FBU.width,i=this._FBU.height,n=s*i*4,r=Math.ceil(s/8)*i;let o=n+r;if(this._sock.rQwait("cursor encoding",o))return!1;const a=this._sock.rQshiftBytes(n),h=this._sock.rQshiftBytes(r);let c=new Uint8Array(s*i*4),d=0;for(let e=0;e<i;e++)for(let t=0;t<s;t++){let i=h[e*Math.ceil(s/8)+Math.floor(t/8)]<<t%8&128?255:0;c[d]=a[d+2],c[d+1]=a[d+1],c[d+2]=a[d],c[d+3]=i,d+=4}return this._updateCursor(c,e,t,s,i),!0}_handleDesktopName(){if(this._sock.rQwait("DesktopName",4))return!1;let e=this._sock.rQshift32();if(this._sock.rQwait("DesktopName",e,4))return!1;let t=this._sock.rQshiftStr(e);return t=decodeUTF8(t,!0),this._setDesktopName(t),!0}_handleExtendedDesktopSize(){if(this._sock.rQwait("ExtendedDesktopSize",4))return!1;const e=this._sock.rQpeek8();let t=4+16*e;if(this._sock.rQwait("ExtendedDesktopSize",t))return!1;const s=!this._supportsSetDesktopSize;this._supportsSetDesktopSize=!0,s&&this._requestRemoteResize(),this._sock.rQskipBytes(1),this._sock.rQskipBytes(3);for(let t=0;t<e;t+=1)0===t?(this._screenID=this._sock.rQshiftBytes(4),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._sock.rQskipBytes(2),this._screenFlags=this._sock.rQshiftBytes(4)):this._sock.rQskipBytes(16);if(1===this._FBU.x&&0!==this._FBU.y){let e="";switch(this._FBU.y){case 1:e="Resize is administratively prohibited";break;case 2:e="Out of resources";break;case 3:e="Invalid screen layout";break;default:e="Unknown reason"}Log.Warn("Server did not accept the resize request: "+e)}else this._resize(this._FBU.width,this._FBU.height);return!0}_handleDataRect(){let e=this._decoders[this._FBU.encoding];if(!e)return this._fail("Unsupported encoding (encoding: "+this._FBU.encoding+")"),!1;try{return e.decodeRect(this._FBU.x,this._FBU.y,this._FBU.width,this._FBU.height,this._sock,this._display,this._fbDepth)}catch(e){return this._fail("Error decoding rect: "+e),!1}}_updateContinuousUpdates(){this._enabledContinuousUpdates&&RFB.messages.enableContinuousUpdates(this._sock,!0,0,0,this._fbWidth,this._fbHeight)}_resize(e,t){this._fbWidth=e,this._fbHeight=t,this._display.resize(this._fbWidth,this._fbHeight),this._updateClip(),this._updateScale(),this._updateContinuousUpdates(),this._saveExpectedClientSize()}_xvpOp(e,t){this._rfbXvpVer<e||(Log.Info("Sending XVP operation "+t+" (version "+e+")"),RFB.messages.xvpOp(this._sock,e,t))}_updateCursor(e,t,s,i,n){this._cursorImage={rgbaPixels:e,hotx:t,hoty:s,w:i,h:n},this._refreshCursor()}_shouldShowDotCursor(){if(!this._showDotCursor)return!1;for(let e=3;e<this._cursorImage.rgbaPixels.length;e+=4)if(this._cursorImage.rgbaPixels[e])return!1;return!0}_refreshCursor(){if("connecting"!==this._rfbConnectionState&&"connected"!==this._rfbConnectionState)return;const e=this._shouldShowDotCursor()?RFB.cursors.dot:this._cursorImage;this._cursor.change(e.rgbaPixels,e.hotx,e.hoty,e.w,e.h)}static genDES(e,t){const s=e.split("").map((e=>e.charCodeAt(0)));return new DES(s).encrypt(t)}}RFB.messages={keyEvent(e,t,s){const i=e._sQ,n=e._sQlen;i[n]=4,i[n+1]=s,i[n+2]=0,i[n+3]=0,i[n+4]=t>>24,i[n+5]=t>>16,i[n+6]=t>>8,i[n+7]=t,e._sQlen+=8,e.flush()},QEMUExtendedKeyEvent(e,t,s,i){const n=e._sQ,r=e._sQlen;n[r]=255,n[r+1]=0,n[r+2]=s>>8,n[r+3]=s,n[r+4]=t>>24,n[r+5]=t>>16,n[r+6]=t>>8,n[r+7]=t;const o=function(e){const t=255&i;return 224===i>>8&&t<127?128|t:e}(i);n[r+8]=o>>24,n[r+9]=o>>16,n[r+10]=o>>8,n[r+11]=o,e._sQlen+=12,e.flush()},pointerEvent(e,t,s,i){const n=e._sQ,r=e._sQlen;n[r]=5,n[r+1]=i,n[r+2]=t>>8,n[r+3]=t,n[r+4]=s>>8,n[r+5]=s,e._sQlen+=6,e.flush()},_buildExtendedClipboardFlags(e,t){let s=new Uint8Array(4),i=0,n=0;for(let t=0;t<e.length;t++)n|=e[t];for(let e=0;e<t.length;e++)i|=t[e];return s[0]=n>>24,s[1]=0,s[2]=0,s[3]=i,s},extendedClipboardProvide(e,t,s){let i=new Deflator,n=[];for(let e=0;e<t.length;e++){if(1!=t[e])throw new Error("Unsupported extended clipboard format for Provide message.");s[e]=s[e].replace(/\r\n|\r|\n/gm,"\r\n");let i=encodeUTF8(s[e]+"\0");n.push(i.length>>24&255,i.length>>16&255,i.length>>8&255,255&i.length);for(let e=0;e<i.length;e++)n.push(i.charCodeAt(e))}let r=i.deflate(new Uint8Array(n)),o=new Uint8Array(4+r.length);o.set(RFB.messages._buildExtendedClipboardFlags([268435456],t)),o.set(r,4),RFB.messages.clientCutText(e,o,!0)},extendedClipboardNotify(e,t){let s=RFB.messages._buildExtendedClipboardFlags([134217728],t);RFB.messages.clientCutText(e,s,!0)},extendedClipboardRequest(e,t){let s=RFB.messages._buildExtendedClipboardFlags([33554432],t);RFB.messages.clientCutText(e,s,!0)},extendedClipboardCaps(e,t,s){let i=Object.keys(s),n=new Uint8Array(4+4*i.length);i.map((e=>parseInt(e))),i.sort(((e,t)=>e-t)),n.set(RFB.messages._buildExtendedClipboardFlags(t,[]));let r=4;for(let e=0;e<i.length;e++)n[r]=s[i[e]]>>24,n[r+1]=s[i[e]]>>16,n[r+2]=s[i[e]]>>8,n[r+3]=s[i[e]]>>0,r+=4,n[3]|=1<<i[e];RFB.messages.clientCutText(e,n,!0)},clientCutText(e,t,s=!1){const i=e._sQ,n=e._sQlen;let r;i[n]=6,i[n+1]=0,i[n+2]=0,i[n+3]=0,r=s?toUnsigned32bit(-t.length):t.length,i[n+4]=r>>24,i[n+5]=r>>16,i[n+6]=r>>8,i[n+7]=r,e._sQlen+=8;let o=0,a=t.length;for(;a>0;){let s=Math.min(a,e._sQbufferSize-e._sQlen);for(let n=0;n<s;n++)i[e._sQlen+n]=t[o+n];e._sQlen+=s,e.flush(),a-=s,o+=s}},setDesktopSize(e,t,s,i,n){const r=e._sQ,o=e._sQlen;r[o]=251,r[o+1]=0,r[o+2]=t>>8,r[o+3]=t,r[o+4]=s>>8,r[o+5]=s,r[o+6]=1,r[o+7]=0,r[o+8]=i>>24,r[o+9]=i>>16,r[o+10]=i>>8,r[o+11]=i,r[o+12]=0,r[o+13]=0,r[o+14]=0,r[o+15]=0,r[o+16]=t>>8,r[o+17]=t,r[o+18]=s>>8,r[o+19]=s,r[o+20]=n>>24,r[o+21]=n>>16,r[o+22]=n>>8,r[o+23]=n,e._sQlen+=24,e.flush()},clientFence(e,t,s){const i=e._sQ,n=e._sQlen;i[n]=248,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=t>>24,i[n+5]=t>>16,i[n+6]=t>>8,i[n+7]=t;const r=s.length;i[n+8]=r;for(let e=0;e<r;e++)i[n+9+e]=s.charCodeAt(e);e._sQlen+=9+r,e.flush()},enableContinuousUpdates(e,t,s,i,n,r){const o=e._sQ,a=e._sQlen;o[a]=150,o[a+1]=t,o[a+2]=s>>8,o[a+3]=s,o[a+4]=i>>8,o[a+5]=i,o[a+6]=n>>8,o[a+7]=n,o[a+8]=r>>8,o[a+9]=r,e._sQlen+=10,e.flush()},pixelFormat(e,t,s){const i=e._sQ,n=e._sQlen;let r;r=t>16?32:t>8?16:8;const o=Math.floor(t/3);i[n]=0,i[n+1]=0,i[n+2]=0,i[n+3]=0,i[n+4]=r,i[n+5]=t,i[n+6]=0,i[n+7]=s?1:0,i[n+8]=0,i[n+9]=(1<<o)-1,i[n+10]=0,i[n+11]=(1<<o)-1,i[n+12]=0,i[n+13]=(1<<o)-1,i[n+14]=0*o,i[n+15]=1*o,i[n+16]=2*o,i[n+17]=0,i[n+18]=0,i[n+19]=0,e._sQlen+=20,e.flush()},clientEncodings(e,t){const s=e._sQ,i=e._sQlen;s[i]=2,s[i+1]=0,s[i+2]=t.length>>8,s[i+3]=t.length;let n=i+4;for(let e=0;e<t.length;e++){const i=t[e];s[n]=i>>24,s[n+1]=i>>16,s[n+2]=i>>8,s[n+3]=i,n+=4}e._sQlen+=n-i,e.flush()},fbUpdateRequest(e,t,s,i,n,r){const o=e._sQ,a=e._sQlen;void 0===s&&(s=0),void 0===i&&(i=0),o[a]=3,o[a+1]=t?1:0,o[a+2]=s>>8&255,o[a+3]=255&s,o[a+4]=i>>8&255,o[a+5]=255&i,o[a+6]=n>>8&255,o[a+7]=255&n,o[a+8]=r>>8&255,o[a+9]=255&r,e._sQlen+=10,e.flush()},xvpOp(e,t,s){const i=e._sQ,n=e._sQlen;i[n]=250,i[n+1]=0,i[n+2]=t,i[n+3]=s,e._sQlen+=4,e.flush()}},RFB.cursors={none:{rgbaPixels:new Uint8Array,w:0,h:0,hotx:0,hoty:0},dot:{rgbaPixels:new Uint8Array([255,255,255,255,0,0,0,255,255,255,255,255,0,0,0,255,0,0,0,0,0,0,0,255,255,255,255,255,0,0,0,255,255,255,255,255]),w:3,h:3,hotx:1,hoty:1}};
//# sourceMappingURL=/sm/7b6d41b5bb0c6dc885092f81684b393e16cf626ab57584a629aeeadb6f82c286.map